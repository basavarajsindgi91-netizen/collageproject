<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BLDEACET | Student Dashboard</title>
    <link rel="icon" type="image/png" href="img/BLD.png">
    <link href='https://fonts.googleapis.com/css?family=Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .toggle-buttons button { margin: 10px; }
        .card { border-radius: 10px; border: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .card-body { background-color: #f8f9fa; }
        .table, .chart-container { margin-top: 20px; }
        .btn-primary { background-color: #0062cc; border: none; }
        .btn-primary:hover { background-color: #0056b3; }
        .alert-info { font-size: 1.1rem; background-color: #e9f7fe; border-color: #b6e1f0; }
        #totalStudents {
            background: linear-gradient(135deg, #00ccbb, #4edfbb);
            color: white;
            font-size: 1.75rem;
            padding: 20px;
            text-align: center;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        #totalStudents:hover { transform: scale(1.05); }
        #totalStudents .total-icon { font-size: 3rem; margin-bottom: 10px; }
        .chart-container { max-width: 100%; overflow: hidden; display: none; }
        .attendance-table { display: none; }
        .table th, .table td { text-align: center; }
        .table th { background-color: #f1f1f1; }
        @media (max-width: 576px) {
            .container { padding: 15px; }
            h1 { font-size: 2rem; }
            .total-students { font-size: 1.25rem; }
            .btn { width: 100%; margin-bottom: 10px; }
            .chart-container, .attendance-table { display: block; margin-top: 20px; }
        }
        .card-body { transition: background-color 0.3s ease-in-out; }
        .card-body:hover { background-color: #f1f1f1; }
        .btn { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="wrapper">
        <header id="header">
            <div class="header-wrapper">
                <div class="header-container">
                    <div>
                        <div class="logo-name">
                            <div class="logo"><a href="index.html" title=""><img src="img/BLD.png" alt="logo"></a></div>
                            <div class="name">
                                <a href="index.html" title="">
                                    <h5>DEPARTMENT OF INFORMATION SCIENCE AND ENGINEERING</h5>
                                    <h5 class="primary-color">BLDEACET</h5>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="header-links">
                        <a href="https://www.google.com/maps?ll=16.847732,75.718501&z=17&t=m&hl=en&gl=IN&mapclient=embed&cid=6385882878560726955" target="_blank" title="Open in Google Maps">
                            <i class="fa fa-map-marker fa-lg" style="color: #FF5733;" aria-hidden="true"></i>
                        </a>
                        <a href="#" data-toggle="popover" title="Phone No." data-content="+91-79-29750281" data-placement="bottom">
                            <i class="fa fa-phone fa-lg" aria-hidden="true"></i>
                        </a>
                        <a href="https://www.youtube.com/@bldeacetmedia7621" target="_blank" title="YouTube">
                            <i class="fa fa-youtube fa-lg" style="color: #FF0000;" aria-hidden="true"></i>
                        </a>
                        <a href="https://www.instagram.com/bldeacetmedia/" target="_blank" title="Instagram">
                            <i class="fa fa-instagram fa-lg" style="color: #C13584;" aria-hidden="true"></i>
                        </a>
                        <a href="https://x.com/i/flow/login?redirect_after_login=%2Fbldeacet" target="_blank" title="Twitter">
                            <i class="fa fa-twitter fa-lg" style="color: #1DA1F2;" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>
            </div>
            <nav>
                <div class="navbar navbar-inverse navbar-custom" role="navigation">
                    <div class="container">
                        <div class="navbar-header">
                            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                                <span class="sr-only">Toggle navigation</span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                                <span class="icon-bar"></span>
                            </button>
                        </div>
                        <div class="collapse navbar-collapse">
                            <ul class="nav navbar-nav">
                                <li><a href="student_details.html">Student Details Entry</a></li>
                                <li>
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">People <b class="caret"></b></a>
                                    <ul class="dropdown-menu multi-level">
                                        <li><a href="faculty.html">Faculty</a></li>
                                        <li><a href="visiting_faculty.html">Visiting Faculty</a></li>
                                        <li><a href="staff.html">Staff</a></li>
                                    </ul>
                                </li>
                                <li>
                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">More <b class="caret"></b></a>
                                    <ul class="dropdown-menu multi-level">
                                        <li><a href="faq.html">FAQs</a></li>
                                        <li><a href="student_corner.html">Student's Corner</a></li>
                                        <li><a href="http://moodle.iiitv.ac.in" target="_blank">Moodle</a></li>
                                        <li><a href="library.html">Library</a></li>
                                        <li><a href="invited_talks.html">Invited Talks</a></li>
                                    </ul>
                                </li>
                                <li><a href="career.html">Career</a></li>
                                <li><a href="gallery.html">Photo Gallery</a></li>
                                <li><a href="attendence.html">Attendance</a></li>
                                <li><a href="marks_entry.html">Marks Entry</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </nav>
        </header>

        <div class="container mt-5">
            <h1 class="text-center mb-4">Student Dashboard</h1>

            <div id="totalStudents" class="alert alert-info text-center">
                <div class="total-icon"><i class="fas fa-users"></i></div>
                <div id="totalStudentsText">Loading...</div>
            </div>

            <div class="mb-4">
                <label for="rollNumber" class="form-label">Enter Roll Number:</label>
                <input type="text" id="rollNumber" class="form-control" placeholder="Roll Number" aria-describedby="rollNumberHelp">
                <small id="rollNumberHelp" class="form-text text-muted">Enter your roll number to fetch the details.</small>
                <button class="btn btn-primary mt-3" onclick="fetchDashboard()">Get Details</button>
            </div>

            <div id="studentDetails" class="card mb-4" style="display: none;">
                <div class="card-body">
                    <h5 class="card-title">Student Details</h5>
                    <p id="studentInfo"></p>
                    <p id="attendanceSummary"></p>
                </div>
            </div>

            <div class="toggle-buttons text-center mb-4">
                <button class="btn btn-outline-primary" onclick="showTable()">View Table</button>
                <button class="btn btn-outline-success" onclick="showGraph()">View Graph</button>
            </div>

            <table class="table table-bordered attendance-table mt-4">
                <thead>
                    <tr>
                        <th>Subject</th>
                        <th>Present</th>
                        <th>Absent</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody"></tbody>
            </table>

            <div class="chart-container">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>

        <footer>
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 text-center">
                        <p>Â© BLDEACET DEPT OF ISE.</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script>
        let chartInstance = null;

        async function fetchTotalStudents() {
            try {
                const response = await fetch('http://localhost:3006/total-students');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                document.getElementById('totalStudentsText').innerHTML = `
                    Total Students: <strong>${data.totalStudents}</strong>
                `;
            } catch (error) {
                console.error('Error fetching total students:', error);
                document.getElementById('totalStudentsText').innerHTML = 'Error loading total students';
            }
        }

        async function fetchDashboard() {
            const rollNumber = document.getElementById('rollNumber').value.trim();
            if (!rollNumber) {
                alert('Please enter a roll number.');
                return;
            }

            try {
                const response = await fetch(`http://localhost:3006/dashboard/${rollNumber}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Network response was not ok');
                }
                const data = await response.json();

                document.getElementById('studentDetails').style.display = 'block';
                const { studentDetails, attendance, totalPercentage, totalClasses } = data;
                document.getElementById('studentInfo').innerHTML = `
                    <strong>Name:</strong> ${studentDetails.studentName || 'N/A'}<br>
                    <strong>Roll Number:</strong> ${studentDetails.studentId}<br>
                    <strong>Semester:</strong> ${studentDetails.semester}<br>
                    <strong>Email:</strong> ${studentDetails.email || 'N/A'}
                `;
                document.getElementById('attendanceSummary').innerHTML = `
                    <strong>Total Attendance_percentage:</strong> ${totalPercentage}%<br>
                    <strong>Total Classes:</strong> ${totalClasses}
                `;

                if (attendance.length === 0) {
                    document.getElementById('attendanceTableBody').innerHTML = '<tr><td colspan="3">No attendance data available</td></tr>';
                    if (chartInstance) chartInstance.destroy();
                    document.getElementById('attendanceChart').style.display = 'none';
                } else {
                    renderTable(attendance);
                    renderGraph(attendance);
                    showTable();
                }
            } catch (error) {
                console.error('Error fetching dashboard:', error);
                document.getElementById('studentDetails').style.display = 'none';
                document.getElementById('attendanceTableBody').innerHTML = '';
                if (chartInstance) chartInstance.destroy();
                alert(error.message === 'Student not found'
                    ? 'No student found with this roll number. Please check and try again.'
                    : `Failed to fetch dashboard data: ${error.message}`);
            }
        }

        function renderTable(attendance) {
            const tbody = document.getElementById('attendanceTableBody');
            tbody.innerHTML = attendance.map(a => `
                <tr>
                    <td>${a.subjectName}</td>
                    <td>${a.totalPresent || 0}</td>
                    <td>${a.totalAbsent || 0}</td>
                </tr>
            `).join('');
        }

        function renderGraph(attendance) {
            const labels = attendance.map(a => a.subjectName);
            const presentData = attendance.map(a => a.totalPresent || 0);
            const absentData = attendance.map(a => a.totalAbsent || 0);

            const ctx = document.getElementById('attendanceChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Present', data: presentData, backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                        { label: 'Absent', data: absentData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'Classes' } } }
                }
            });
        }

        function showTable() {
            document.querySelector('.attendance-table').style.display = 'table';
            document.querySelector('.chart-container').style.display = 'none';
        }

        function showGraph() {
            document.querySelector('.attendance-table').style.display = 'none';
            document.querySelector('.chart-container').style.display = 'block';
        }

        $(document).ready(function() {
            fetchTotalStudents();
            $('[data-toggle="popover"]').popover();
        });
    </script>
</body>
</html>